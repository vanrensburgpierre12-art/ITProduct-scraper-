<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronics Distributors Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .product-card {
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .stock-badge {
            font-size: 0.8em;
        }
        .progress-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="jumbotron bg-primary text-white p-4 mb-4">
                    <h1 class="display-4"><i class="fas fa-robot"></i> Electronics Distributors Scraper</h1>
                    <p class="lead">Scrape product data from South African electronics distributors</p>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Scraper Control</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Select Distributors:</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Communica" id="communica" checked>
                                    <label class="form-check-label" for="communica">
                                        <i class="fas fa-store"></i> Communica
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="MicroRobotics" id="microrobotics" checked>
                                    <label class="form-check-label" for="microrobotics">
                                        <i class="fas fa-microchip"></i> MicroRobotics
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Miro" id="miro" checked>
                                    <label class="form-check-label" for="miro">
                                        <i class="fas fa-shopping-cart"></i> Miro Distribution
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button id="startBtn" class="btn btn-success btn-lg mb-2">
                                    <i class="fas fa-play"></i> Start Scraping
                                </button>
                                <button id="stopBtn" class="btn btn-danger btn-lg mb-2" disabled>
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <div class="mt-3">
                                    <button id="downloadCsv" class="btn btn-outline-primary me-2" disabled>
                                        <i class="fas fa-download"></i> Download CSV
                                    </button>
                                    <button id="downloadJson" class="btn btn-outline-secondary" disabled>
                                        <i class="fas fa-download"></i> Download JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <h5><i class="fas fa-chart-line"></i> Status</h5>
                        <div id="statusText">Ready to start</div>
                        <div id="progressContainer" class="progress-container" style="display: none;">
                            <div class="progress mb-2">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="progressText">0%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4" id="statsRow" style="display: none;">
            <div class="col-12">
                <div class="card stats-card">
                    <div class="card-body">
                        <h5><i class="fas fa-chart-bar"></i> Statistics</h5>
                        <div class="row" id="statsContent">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> Products</h5>
                        <div>
                            <select id="pageSize" class="form-select d-inline-block w-auto me-2">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                            <div id="pagination" class="d-inline-block">
                                <!-- Pagination will be added here -->
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="productsTable">
                            <div class="text-center text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No products loaded. Start scraping to see results.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;

        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadCsv = document.getElementById('downloadCsv');
        const downloadJson = document.getElementById('downloadJson');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const productsTable = document.getElementById('productsTable');
        const statsRow = document.getElementById('statsRow');
        const statsContent = document.getElementById('statsContent');
        const pagination = document.getElementById('pagination');
        const pageSizeSelect = document.getElementById('pageSize');

        // Event listeners
        startBtn.addEventListener('click', startScraping);
        stopBtn.addEventListener('click', stopScraping);
        downloadCsv.addEventListener('click', () => downloadFile('csv'));
        downloadJson.addEventListener('click', () => downloadFile('json'));
        pageSizeSelect.addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            loadProducts();
        });

        // Start scraping
        function startScraping() {
            const selectedDistributors = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedDistributors.length === 0) {
                alert('Please select at least one distributor');
                return;
            }

            startBtn.disabled = true;
            stopBtn.disabled = false;
            progressContainer.style.display = 'block';
            statusText.textContent = 'Starting...';

            fetch('/api/start_scraping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ distributors: selectedDistributors })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    resetButtons();
                } else {
                    startStatusPolling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting scraper');
                resetButtons();
            });
        }

        // Stop scraping
        function stopScraping() {
            // Note: This is a placeholder - actual stop functionality would need to be implemented
            alert('Stop functionality not implemented yet');
        }

        // Reset buttons
        function resetButtons() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            progressContainer.style.display = 'none';
        }

        // Start polling for status updates
        function startStatusPolling() {
            const interval = setInterval(() => {
                fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatus(data);
                    if (!data.is_running) {
                        clearInterval(interval);
                        resetButtons();
                        loadProducts();
                        loadStats();
                        downloadCsv.disabled = false;
                        downloadJson.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error polling status:', error);
                    clearInterval(interval);
                    resetButtons();
                });
            }, 1000);
        }

        // Update status display
        function updateStatus(status) {
            if (status.is_running) {
                statusText.textContent = `Scraping ${status.current_distributor}...`;
                progressBar.style.width = `${status.progress}%`;
                progressText.textContent = `${status.progress}%`;
            } else if (status.error) {
                statusText.textContent = `Error: ${status.error}`;
            } else {
                statusText.textContent = 'Completed';
            }
        }

        // Load products
        function loadProducts() {
            fetch(`/api/products?page=${currentPage}&per_page=${pageSize}`)
            .then(response => response.json())
            .then(data => {
                displayProducts(data.products);
                updatePagination(data.page, data.total_pages);
            })
            .catch(error => {
                console.error('Error loading products:', error);
            });
        }

        // Display products in table
        function displayProducts(products) {
            if (products.length === 0) {
                productsTable.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No products found</p>
                    </div>
                `;
                return;
            }

            const table = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Product Name</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Price (Inc VAT)</th>
                                <th>Stock Status</th>
                                <th>Brand</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => `
                                <tr>
                                    <td><span class="badge bg-primary">${product.Source}</span></td>
                                    <td>${product['Product Name'] || 'N/A'}</td>
                                    <td><code>${product.SKU || 'N/A'}</code></td>
                                    <td>${product.Category || 'N/A'}</td>
                                    <td>${product['Price (Inc VAT)'] ? 'R' + product['Price (Inc VAT)'] : 'N/A'}</td>
                                    <td>
                                        <span class="badge stock-badge ${getStockBadgeClass(product['Stock Status'])}">
                                            ${product['Stock Status'] || 'Unknown'}
                                        </span>
                                    </td>
                                    <td>${product.Brand || 'N/A'}</td>
                                    <td>
                                        <a href="${product['Product URL']}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            productsTable.innerHTML = table;
        }

        // Get stock badge class
        function getStockBadgeClass(status) {
            switch(status) {
                case 'In Stock': return 'bg-success';
                case 'Out of Stock': return 'bg-danger';
                case 'Low Stock': return 'bg-warning';
                case 'Notify Me': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // Update pagination
        function updatePagination(page, totalPages) {
            currentPage = page;
            totalPages = totalPages;
            
            let paginationHtml = '';
            
            if (totalPages > 1) {
                paginationHtml += '<nav><ul class="pagination pagination-sm">';
                
                // Previous button
                paginationHtml += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${page - 1})">Previous</a>
                </li>`;
                
                // Page numbers
                const startPage = Math.max(1, page - 2);
                const endPage = Math.min(totalPages, page + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                }
                
                // Next button
                paginationHtml += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${page + 1})">Next</a>
                </li>`;
                
                paginationHtml += '</ul></nav>';
            }
            
            pagination.innerHTML = paginationHtml;
        }

        // Change page
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadProducts();
            }
        }

        // Load statistics
        function loadStats() {
            fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    return;
                }
                
                statsRow.style.display = 'block';
                statsContent.innerHTML = `
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>${data.total_products}</h3>
                            <p>Total Products</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>${Object.keys(data.by_distributor).length}</h3>
                            <p>Distributors</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>R${data.price_range.avg ? data.price_range.avg.toFixed(2) : '0'}</h3>
                            <p>Avg Price</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>${data.by_stock_status['In Stock'] || 0}</h3>
                            <p>In Stock</p>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
        }

        // Download file
        function downloadFile(format) {
            const url = format === 'csv' ? '/api/download_csv' : '/api/download_json';
            window.open(url, '_blank');
        }

        // Load initial data
        loadProducts();
    </script>
</body>
</html>